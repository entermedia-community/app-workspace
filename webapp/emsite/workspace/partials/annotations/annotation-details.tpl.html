<a ui-sref="app.annotations">Back to Annotations</a>
{{currentAnnotation}} {{currentAnnotation.annotation.path}}

<!-- Fabric experiment below 
	weird that it doesn't include the angular controller
	or the canvas tag css, the wrappers are odd-->

<div id="bd-wrapper">
    <h2><span>Annotation Canvas</span> &middot; Test phase</h2>
    {{currentAnnotation}}

    <canvas class="coveredImage" id="annotation_canvas" width="800" height="600" style="border:1px solid #aaa"></canvas>
    <!--<div class="outsideWrapper">
    	<div class="insideWrapper">
		
    	</div>
	</div>-->

    <div style="display: inline-block; margin-left: 10px">
        <button id="drawing-mode" class="btn btn-info">Cancel drawing mode</button>
        <br>
        <button id="clear-canvas" class="btn btn-info">Clear</button>
        <br>
        <!-- add new button to create image flattening -->
        <button id="image-to-json" class="btn btn-info">Canvas to JSON</button>
        <br>

        <div id="drawing-mode-options">
            <label for="drawing-mode-selector">Mode:</label>
            <select id="drawing-mode-selector">
                <option>Pencil</option>
                <option>Circle</option>
                <option>Spray</option>
                <option>Pattern</option>

                <option>hline</option>
                <option>vline</option>
                <option>square</option>
                <option>diamond</option>
                <option>texture</option>
            </select>
            <br>

            <label for="drawing-line-width">Line width:</label>
            <span class="info">30</span>
            <input type="range" value="30" min="0" max="150" id="drawing-line-width">
            <br>

            <label for="drawing-color">Line color:</label>
            <input type="color" value="#005E7A" id="drawing-color">
            <br>

            <label for="drawing-shadow-color">Shadow color:</label>
            <input type="color" value="#005E7A" id="drawing-shadow-color">
            <br>

            <label for="drawing-shadow-width">Shadow width:</label>
            <span class="info">0</span>
            <input type="range" value="0" min="0" max="50" id="drawing-shadow-width">
            <br>

            <label for="drawing-shadow-offset">Shadow offset:</label>
            <span class="info">0</span>
            <input type="range" value="0" min="0" max="50" id="drawing-shadow-offset">
            <br>
        </div>
    </div>

    <!-- test angular output-->
    <p>
        <img src='{{currentAnnotation.annotation.path}}'></img>
    </p>
    {{currentAnnotation.annotation.path}}
    <!-- /test -->

    <script id="main">
		(function () {
		    var $ = function (id) {
		        return document.getElementById(id)
		    };

		    var canvas = this.__canvas = new fabric.Canvas('annotation_canvas', {
		        isDrawingMode: true
		    });
		    // var img = new fabric.Image.fromURL('http://sd.keepcalm-o-matic.co.uk/i/keep-calm-and-do-stuff-things-5.png');
		    // using the Image.fromURL() method seems to break the canvas drawing tools 

		    //

		    canvas.setBackgroundImage('{{currentAnnotation.annotation.path}}', canvas.renderAll.bind(canvas));

		    var drawingModeEl = $('drawing-mode'),
		        drawingOptionsEl = $('drawing-mode-options'),
		        drawingColorEl = $('drawing-color'),
		        drawingShadowColorEl = $('drawing-shadow-color'),
		        drawingLineWidthEl = $('drawing-line-width'),
		        drawingShadowWidth = $('drawing-shadow-width'),
		        drawingShadowOffset = $('drawing-shadow-offset'),
		        clearEl = $('clear-canvas'),
		        imageJSONEl = $('image-to-json');

		    clearEl.onclick = function () {
		        canvas.clear()
		    };

		    drawingModeEl.onclick = function () {
		        canvas.isDrawingMode = !canvas.isDrawingMode;
		        if (canvas.isDrawingMode) {
		            drawingModeEl.innerHTML = 'Cancel drawing mode';
		            drawingOptionsEl.style.display = '';
		        }
		        else {
		            drawingModeEl.innerHTML = 'Enter drawing mode';
		            drawingOptionsEl.style.display = 'none';
		        }
		    };

		    imageJSONEl.onclick = function () {

		        // convert canvas to a json string

		        var json = JSON.stringify(canvas.toJSON());

		        console.log(json);

		    };

		    if (fabric.PatternBrush) {
		        var vLinePatternBrush = new fabric.PatternBrush(canvas);
		        vLinePatternBrush.getPatternSrc = function () {

		            var patternCanvas = fabric.document.createElement('canvas');
		            patternCanvas.width = patternCanvas.height = 10;
		            var ctx = patternCanvas.getContext('2d');

		            ctx.strokeStyle = this.color;
		            ctx.lineWidth = 5;
		            ctx.beginPath();
		            ctx.moveTo(0, 5);
		            ctx.lineTo(10, 5);
		            ctx.closePath();
		            jquery
		            ctx.stroke();

		            return patternCanvas;
		        };

		        var hLinePatternBrush = new fabric.PatternBrush(canvas);
		        hLinePatternBrush.getPatternSrc = function () {

		            var patternCanvas = fabric.document.createElement('canvas');
		            patternCanvas.width = patternCanvas.height = 10;
		            var ctx = patternCanvas.getContext('2d');

		            ctx.strokeStyle = this.color;
		            ctx.lineWidth = 5;
		            ctx.beginPath();
		            ctx.moveTo(5, 0);
		            ctx.lineTo(5, 10);
		            ctx.closePath();
		            ctx.stroke();

		            return patternCanvas;
		        };

		        var squarePatternBrush = new fabric.PatternBrush(canvas);
		        squarePatternBrush.getPatternSrc = function () {

		            var squareWidth = 10,
		                squareDistance = 2;

		            var patternCanvas = fabric.document.createElement('canvas');
		            patternCanvas.width = patternCanvas.height = squareWidth + squareDistance;
		            var ctx = patternCanvas.getContext('2d');

		            ctx.fillStyle = this.color;
		            ctx.fillRect(0, 0, squareWidth, squareWidth);

		            return patternCanvas;
		        };

		        var diamondPatternBrush = new fabric.PatternBrush(canvas);
		        diamondPatternBrush.getPatternSrc = function () {

		            var squareWidth = 10,
		                squareDistance = 5;
		            var patternCanvas = fabric.document.createElement('canvas');
		            var rect = new fabric.Rect({
		                width: squareWidth,
		                height: squareWidth,
		                angle: 45,
		                fill: this.color
		            });

		            var canvasWidth = rect.getBoundingRectWidth();

		            patternCanvas.width = patternCanvas.height = canvasWidth + squareDistance;
		            rect.set({
		                left: canvasWidth / 2,
		                top: canvasWidth / 2
		            });

		            var ctx = patternCanvas.getContext('2d');
		            rect.render(ctx);

		            return patternCanvas;
		        };

		        var img = new Image();
		        img.src = 'http://www.entropiaplanets.com/w/images/c/cd/Warning_sign.png';
		        // ../assets/honey_im_subtle.png
		        var texturePatternBrush = new fabric.PatternBrush(canvas);
		        texturePatternBrush.source = img;
		    }

		    $('drawing-mode-selector').onchange = function () {

		        if (this.value === 'hline') {
		            canvas.freeDrawingBrush = vLinePatternBrush;
		        }
		        else if (this.value === 'vline') {
		            canvas.freeDrawingBrush = hLinePatternBrush;
		        }
		        else if (this.value === 'square') {
		            canvas.freeDrawingBrush = squarePatternBrush;
		        }
		        else if (this.value === 'diamond') {
		            canvas.freeDrawingBrush = diamondPatternBrush;
		        }
		        else if (this.value === 'texture') {
		            canvas.freeDrawingBrush = texturePatternBrush;
		        }
		        else {
		            canvas.freeDrawingBrush = new fabric[this.value + 'Brush'](canvas);
		        }

		        if (canvas.freeDrawingBrush) {
		            canvas.freeDrawingBrush.color = drawingColorEl.value;
		            canvas.freeDrawingBrush.width = parseInt(drawingLineWidthEl.value, 10) || 1;
		            canvas.freeDrawingBrush.shadowBlur = parseInt(drawingShadowWidth.value, 10) || 0;
		        }
		    };

		    drawingColorEl.onchange = function () {
		        canvas.freeDrawingBrush.color = this.value;
		    };
		    drawingShadowColorEl.onchange = function () {
		        canvas.freeDrawingBrush.shadowColor = this.value;
		    };
		    drawingLineWidthEl.onchange = function () {
		        canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
		        this.previousSibling.innerHTML = this.value;
		    };
		    drawingShadowWidth.onchange = function () {
		        canvas.freeDrawingBrush.shadowBlur = parseInt(this.value, 10) || 0;
		        this.previousSibling.innerHTML = this.value;
		    };
		    drawingShadowOffset.onchange = function () {
		        canvas.freeDrawingBrush.shadowOffsetX =
		            canvas.freeDrawingBrush.shadowOffsetY = parseInt(this.value, 10) || 0;
		        this.previousSibling.innerHTML = this.value;
		    };

		    if (canvas.freeDrawingBrush) {
		        canvas.freeDrawingBrush.color = drawingColorEl.value;
		        canvas.freeDrawingBrush.width = parseInt(drawingLineWidthEl.value, 10) || 1;
		        canvas.freeDrawingBrush.shadowBlur = 0;
		    }
		})();
    </script>

    <script>
		(function () {
		    var mainScriptEl = document.getElementById('main');
		    if (!mainScriptEl) return;
		    var preEl = document.createElement('pre');
		    var codeEl = document.createElement('code');
		    codeEl.innerHTML = mainScriptEl.innerHTML;
		    codeEl.className = 'language-javascript';
		    preEl.appendChild(codeEl);
		    document.getElementById('bd-wrapper').appendChild(preEl);
		})();
    </script>

    <script>
		(function () {
		    fabric.util.addListener(fabric.window, 'load', function () {
		        var canvas = this.__canvas || this.canvas,
		            canvases = this.__canvases || this.canvases;

		        canvas && canvas.calcOffset && canvas.calcOffset();

		        if (canvases && canvases.length) {
		            for (var i = 0, len = canvases.length; i < len; i++) {
		                canvases[i].calcOffset();
		            }
		        }
		    });
		})();
    </script>

</div>